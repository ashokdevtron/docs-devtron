"use strict";(self.webpackChunkdocdevtron=self.webpackChunkdocdevtron||[]).push([[9569],{7329:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"user-guide/global-configurations/image-promotion-policy","title":"Image Promotion Policy","description":"Introduction","source":"@site/docs/user-guide/global-configurations/image-promotion-policy.md","sourceDirName":"user-guide/global-configurations","slug":"/user-guide/global-configurations/image-promotion-policy","permalink":"/docs-devtron/docs/user-guide/global-configurations/image-promotion-policy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Catalog Framework","permalink":"/docs-devtron/docs/user-guide/global-configurations/catalog-framework"},"next":{"title":"Introduction to Devtron","permalink":"/docs-devtron/docs/"}}');var t=n(4848),r=n(8453);const s={},a="Image Promotion Policy",l={},c=[{value:"Introduction",id:"introduction-",level:2},{value:"Creating an Image Promotion Policy",id:"creating-an-image-promotion-policy",level:2},{value:"Applying an Image Promotion Policy",id:"applying-an-image-promotion-policy",level:2},{value:"Result",id:"result",level:2},{value:"Promoting Image to Target Environment",id:"promoting-image-to-target-environment",level:3},{value:"Approving Image Promotion Request",id:"approving-image-promotion-request",level:3},{value:"Deploying a Promoted Image",id:"deploying-a-promoted-image",level:3}];function p(e){const o={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.header,{children:(0,t.jsx)(o.h1,{id:"image-promotion-policy",children:"Image Promotion Policy"})}),"\n",(0,t.jsxs)(o.h2,{id:"introduction-",children:["Introduction ",(0,t.jsx)(o.a,{href:"https://devtron.ai/pricing",children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/elements/EnterpriseTag.svg",alt:""})})]}),"\n",(0,t.jsx)(o.p,{children:"An ideal deployment workflow may consist of multiple stages (e.g., SIT, UAT, Prod environment)."}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/sample-cd-workflow.jpg",alt:"Figure 1: Workflow on Devtron"})}),"\n",(0,t.jsxs)(o.p,{children:["If you have built such a ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/creating-application/workflow/",children:"workflow"}),", your CI image will sequentially traverse and deploy to each environment until it reaches the target environment. However, if there's a critical issue you wish to address urgently (through a hotfix) on production, navigating the standard workflow might feel slow and cumbersome."]}),"\n",(0,t.jsx)(o.p,{children:"Therefore, Devtron offers a feature called 'Image Promotion Policy' that allows you to directly promote an image to the target environment, bypassing the intermediate stages in your workflow including:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/creating-application/workflow/cd-pipeline#pre-deployment-stage",children:"Pre-CD"})," and ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/creating-application/workflow/cd-pipeline#post-deployment-stage",children:"Post-CD"})," of the intermediate stages"]}),"\n",(0,t.jsxs)(o.li,{children:["All ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/global-configurations/approval-policy",children:"approval nodes"})," of the intermediate stages"]}),"\n"]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/image-promotion-visual.jpg",alt:"Figure 2: Promoting an Image"})}),"\n",(0,t.jsx)(o.hr,{}),"\n",(0,t.jsx)(o.h2,{id:"creating-an-image-promotion-policy",children:"Creating an Image Promotion Policy"}),"\n",(0,t.jsx)(o.admonition,{title:"Who Can Perform This Action?",type:"caution",children:(0,t.jsx)(o.p,{children:"Users need to have super-admin permission to create an image promotion policy."})}),"\n",(0,t.jsxs)(o.p,{children:["You can create a policy using our APIs or through Devtron CLI. To get the latest version of the ",(0,t.jsx)(o.strong,{children:"devtctl"})," binary, please contact your enterprise POC or reach out to us directly for further assistance."]}),"\n",(0,t.jsx)(o.p,{children:"Here is the CLI approach:"}),"\n",(0,t.jsxs)(o.p,{children:[(0,t.jsx)(o.strong,{children:"Syntax"}),":"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:'devtctl create imagePromotionPolicy \\\n    --name="example-policy" \\\n    --description="This is a sample policy that promotes an image to production environment" \\\n    --passCondition="true" \\\n    --failCondition="false" \\\n    --approverCount=0 \\\n    --allowRequestFromApprove=false \\\n    --allowImageBuilderFromApprove=false \\\n    --allowApproverFromDeploy=false \\\n    --applyPath="path/to/applyPolicy.yaml"\n'})}),"\n",(0,t.jsxs)(o.p,{children:[(0,t.jsx)(o.strong,{children:"Arguments"}),":"]}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--name"})," (required): The name of the image promotion policy."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--description"})," (optional): A brief description of the policy, preferably explaining what it does."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--passCondition"})," (optional): Specify a condition using ",(0,t.jsx)(o.a,{href:"https://github.com/google/cel-spec/blob/master/doc/langdef.md",children:"Common Expression Language (CEL)"}),". Images that match this condition will be eligible for promotion to the target environment."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--failCondition"})," (optional): Images that match this condition will NOT be eligible for promotion to the target environment."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--approverCount"})," (optional): The number of approvals required to promote an image (0-6). Defaults to 0 (no approvals)."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--allowRequestFromApprove"})," (optional): (Boolean) If true, user who raised the image promotion request can approve it. Defaults to false."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--allowImageBuilderFromApprove"})," (optional): (Boolean) If true, user who triggered the build can approve the image promotion request. Defaults to false."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--allowApproverFromDeploy"})," (optional): (Boolean) If true, user who approved the image promotion request can deploy that image. Defaults to false."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"--applyPath"})," (optional): Specify the path to the YAML file that contains the list of applications and environments to which the policy should be applicable."]}),"\n"]}),"\n",(0,t.jsxs)(o.admonition,{type:"info",children:[(0,t.jsx)(o.mdxAdmonitionTitle,{}),(0,t.jsx)(o.p,{children:"If an image matches both pass and fail conditions, the priority of the fail condition will be higher. Therefore, such image will NOT be eligible for promotion to the target environment."})]}),"\n",(0,t.jsxs)(o.admonition,{type:"info",children:[(0,t.jsx)(o.mdxAdmonitionTitle,{}),(0,t.jsx)(o.p,{children:"If you don't define both pass and fail conditions, all images will be eligible for promotion."})]}),"\n",(0,t.jsx)(o.hr,{}),"\n",(0,t.jsx)(o.h2,{id:"applying-an-image-promotion-policy",children:"Applying an Image Promotion Policy"}),"\n",(0,t.jsx)(o.admonition,{title:"Who Can Perform This Action?",type:"caution",children:(0,t.jsx)(o.p,{children:"Users need to have super-admin permission to apply an image promotion policy."})}),"\n",(0,t.jsx)(o.p,{children:"You can apply a policy using our APIs or through Devtron CLI. Here is the CLI approach:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["Create a YAML file and give it a name (say ",(0,t.jsx)(o.code,{children:"applyPolicy.yaml"}),"). Within the file, define the applications and environments to which the image promotion policy should apply, as shown below."]}),"\n"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yml",metastring:'title="applyPolicy.yaml" showLineNumbers',children:'apiVersion: v1\nkind: artifactPromotionPolicy\nspec:\n  payload:\n    applicationEnvironments:\n      - appName: "app1"\n        envName: "env-demo"\n      - appName: "app1"\n        envName: "env-staging"\n      - appName: "app2"\n        envName: "env-demo"\n    applyToPolicyNames:\n      - "example-policy"\n'})}),"\n",(0,t.jsxs)(o.p,{children:["Here, ",(0,t.jsx)(o.code,{children:"applicationEnvironments"})," is a dictionary that contains the application names (app1, app2) and the corresponding environment names (env-demo/env-staging) where the policy will apply. In the ",(0,t.jsx)(o.code,{children:"applyToPolicyName"})," key, enter the value of the ",(0,t.jsx)(o.code,{children:"name"})," argument you used earlier while ",(0,t.jsx)(o.a,{href:"#creating-an-image-promotion-policy",children:"creating the policy"}),"."]}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsx)(o.p,{children:"Apply the policy using the following CLI command:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{children:'devtctl apply policy -p="path/to/applyPolicy.yaml"\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(o.h2,{id:"result",children:"Result"}),"\n",(0,t.jsx)(o.h3,{id:"promoting-image-to-target-environment",children:"Promoting Image to Target Environment"}),"\n",(0,t.jsx)(o.admonition,{title:"Who Can Perform This Action?",type:"caution",children:(0,t.jsx)(o.p,{children:"Users with build & deploy permission or above (for the application and target environment) can promote an image if the image promotion policy is enabled."})}),"\n",(0,t.jsx)(o.p,{children:"Here, you can promote images to the target environment(s)."}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Go to the ",(0,t.jsx)(o.strong,{children:"Build & Deploy"})," tab of your application."]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Click the ",(0,t.jsx)(o.strong,{children:"Promote"})," button next to the workflow in which the you wish to promote the image. Please note, the button will appear only if image promotion is allowed for any environment used in that workflow."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/promote-button.jpg",alt:"Figure 3: Promote Button"})}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["In the ",(0,t.jsx)(o.code,{children:"Select Image"})," tab, you will see a list of images. Use the ",(0,t.jsx)(o.strong,{children:"Show Images from"})," dropdown to filter the list and choose the image you wish to promote. This can be either be an image from the CI pipeline or one that has successfully passed all stages (e.g., pre, post, if any) of that particular environment."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/show-images.jpg",alt:"Figure 4: Selecting an Image"})}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Use the ",(0,t.jsx)(o.strong,{children:"SELECT"})," button on the image, and click ",(0,t.jsx)(o.strong,{children:"Promote to..."})]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsx)(o.p,{children:"Select one or more target environments using the checkbox."}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/selecting-env.jpg",alt:"Figure 5: Selecting the Destination Environment"})}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Click ",(0,t.jsx)(o.strong,{children:"Promote Image"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(o.p,{children:"The image's promotion to the target environment now depends on the approval settings in the image promotion policy. If the super-admin has enforced an approval process, the image requires the necessary number of approvals before promotion. On the other hand, if the super-admin has not enforced approval, the image will be automatically promoted since there is no request phase involved."}),"\n",(0,t.jsxs)(o.admonition,{type:"caution",children:[(0,t.jsx)(o.mdxAdmonitionTitle,{}),(0,t.jsxs)(o.p,{children:["In case you have configured ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/global-configurations/manage-notification#configurations",children:"SES or SMTP on Devtron"}),", an email notification will be sent to the approvers."]})]}),"\n",(0,t.jsxs)(o.ol,{start:"7",children:["\n",(0,t.jsxs)(o.li,{children:["If approval(s) are required for image promotion, you may check the status of your request in the ",(0,t.jsx)(o.code,{children:"Approval Pending"})," tab."]}),"\n"]}),"\n",(0,t.jsx)(o.h3,{id:"approving-image-promotion-request",children:"Approving Image Promotion Request"}),"\n",(0,t.jsx)(o.admonition,{title:"Who Can Perform This Action?",type:"caution",children:(0,t.jsxs)(o.p,{children:["Only the users having ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/global-configurations/user-access#devtron-apps-permissions",children:"Artifact promoter"})," role (for the application and environment) or superadmin permissions will be able to approve the image promotion request."]})}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Go to the ",(0,t.jsx)(o.strong,{children:"Build & Deploy"})," tab of your application."]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Click the ",(0,t.jsx)(o.strong,{children:"Promote"})," button next to the workflow."]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Go to the ",(0,t.jsx)(o.code,{children:"Approval Pending"})," tab to see the list of images requiring approval. By default, it shows a list of all images whose promotion request is pending with you."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/pending-approvals.jpg",alt:"Figure 6: Checking Pending Approvals"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.admonition,{type:"info",children:[(0,t.jsx)(o.mdxAdmonitionTitle,{}),(0,t.jsx)(o.p,{children:"All the images will show the source from which it is being promoted, i.e., CI stage or intermediate stage (environment)."})]}),"\n",(0,t.jsxs)(o.ol,{start:"4",children:["\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Click ",(0,t.jsx)(o.strong,{children:"Approve for..."})," to choose the target environments to which it can be promoted."]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Click ",(0,t.jsx)(o.strong,{children:"Approve"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.p,{children:["You can also use the ",(0,t.jsx)(o.strong,{children:"Show requests"})," dropdown to filter the image promotion requests for a specific target environment."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/show-requests.jpg",alt:"Figure 7: Show Env-specific Promotion Requests"})}),"\n",(0,t.jsx)(o.p,{children:"If there are pending promotion requests, you can approve them as shown below:"}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/image-promo-approval.gif",alt:"Figure 8: Approving Image Promotion Requests"})}),"\n",(0,t.jsx)(o.h3,{id:"deploying-a-promoted-image",children:"Deploying a Promoted Image"}),"\n",(0,t.jsx)(o.admonition,{title:"Who Can Perform This Action?",type:"caution",children:(0,t.jsx)(o.p,{children:"Users with build & deploy permission or above for the application and environment can deploy the promoted image."})}),"\n",(0,t.jsxs)(o.p,{children:["If a user has approved the promotion request for an image, they may or may not be able to deploy depending upon the ",(0,t.jsx)(o.a,{href:"#creating-an-image-promotion-policy",children:"policy configuration"}),"."]}),"\n",(0,t.jsxs)(o.p,{children:["However, a promoted image does not automatically qualify as a deployable image. It must fulfill all configured requirements (",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/global-configurations/approval-policy",children:"Image Deployment Approval"}),", ",(0,t.jsx)(o.a,{href:"/docs-devtron/docs/user-guide/global-configurations/filter-condition",children:"Filter Conditions"}),", etc.) of the target environment for it to be deployed."]}),"\n",(0,t.jsxs)(o.p,{children:["In the ",(0,t.jsx)(o.strong,{children:"Build & Deploy"})," tab of your application, click ",(0,t.jsx)(o.strong,{children:"Select Image"})," for the CD pipeline, and choose your promoted image for deployment."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/deploying-promoted-image.jpg",alt:"Figure 9: Deploying Promoted Image"})}),"\n",(0,t.jsxs)(o.p,{children:["You can check the deployment of promoted images in the ",(0,t.jsx)(o.strong,{children:"Deployment History"})," of your application. It will also indicate the pipeline from which the image was promoted and deployed to the target environment."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://devtron-public-asset.s3.us-east-2.amazonaws.com/images/global-configurations/image-promotion/promoted-image-deploy-log.jpg",alt:"Figure 10: Deployment History - Checking Image Source"})})]})}function d(e={}){const{wrapper:o}={...(0,r.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>s,x:()=>a});var i=n(6540);const t={},r=i.createContext(t);function s(e){const o=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function a(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),i.createElement(r.Provider,{value:o},e.children)}}}]);